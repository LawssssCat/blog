import{_ as c,r as t,o as k,c as d,d as s,e as a,b as e,w as i,f as r}from"./app-BcXDjejK.js";const h={},y=r('<h2 id="概念" tabindex="-1"><a class="header-anchor" href="#概念"><span>概念</span></a></h2><h3 id="juc" tabindex="-1"><a class="header-anchor" href="#juc"><span>JUC</span></a></h3><p>JUC <code>java.util.concurrent</code> 缩写</p><p>并发场景进行多线程编程的工具类</p><h3 id="进程、线程、协程" tabindex="-1"><a class="header-anchor" href="#进程、线程、协程"><span>进程、线程、协程</span></a></h3><p><strong>进程</strong> —— 一个应用，系统资源分配单位</p><p><strong>线程</strong> —— 一个应用的其中一个任务，共享进程资源</p><p><strong>协程</strong>/<strong>虚拟线程（Visual Thread）</strong> —— 在一个任务中，实现多任务有序的协作开展任务</p><ul><li>一个线程中可以有多个虚拟线程</li><li>不由系统管理，由 jvm 管理</li><li>由于由 jvm 管理，完全在内存中进行状态切换，所以创建和销毁的开销小，更高效</li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>可以形象的理解： 进程=饭馆；线程=饭桌；协程=座椅；</p></div><h4 id="内核线程" tabindex="-1"><a class="header-anchor" href="#内核线程"><span>内核线程</span></a></h4><p>线程实现方式有三种：</p><ol><li>使用内核线程实现</li><li>使用用户线程实现</li><li>使用用户线程 + 内核线程混合实现</li></ol><p>内核线程（Kernel-Level Thread，KLT）就是直接由操作系统内核（Kernel）支持的线程。这种线程由操作系统内核来完成线程切换，操作系统内核通过操纵调度器（Scheduler）对线程进行调度，并负责将线程的任务映射刀各个处理器上。</p>',14),B=r(`<p>可以参考 linux 源码</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">Thread.c</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">jvm.h</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">jvm.cpp</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">thread.cpp</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">os_linux.cpp</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),E={href:"https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=11",target:"_blank",rel:"noopener noreferrer"},u=r(`<p><strong>Java 创建线程的方式就是采用内核线程的方式创建的</strong></p><h4 id="内核线程数量" tabindex="-1"><a class="header-anchor" href="#内核线程数量"><span>内核线程数量</span></a></h4><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"># 查看指定参数</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sysctl</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> -a</span><span style="color:#D73A49;--shiki-dark:#ABB2BF;"> |</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> grep</span><span style="color:#032F62;--shiki-dark:#98C379;"> threads-max</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> # 查看所有参数</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sysctl</span><span style="color:#032F62;--shiki-dark:#98C379;"> kernel.threads-max</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">cat</span><span style="color:#032F62;--shiki-dark:#98C379;"> /proc/sys/kernel/threads-max</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> # 内核参数在 /proc/sys 目录下的格式为： 目录.文件</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"># 修改指定参数</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sysctl</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> -w</span><span style="color:#032F62;--shiki-dark:#98C379;"> kernel.threads-max=</span><span style="color:#005CC5;--shiki-dark:#D19A66;">102400</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> # 修改 /etc/sysctl.conf 文件，该文件在系统重启后自动加载</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"># 手动生效配置</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sysctl</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> -p</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当实际线程数量超过上述设置值后，Java 继续创建线程会报错：</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">Exception</span><span style="color:#032F62;--shiki-dark:#98C379;"> in</span><span style="color:#032F62;--shiki-dark:#98C379;"> thread</span><span style="color:#032F62;--shiki-dark:#98C379;"> &quot;main&quot;</span><span style="color:#032F62;--shiki-dark:#98C379;"> java.lang.OutOfMemoryError:</span><span style="color:#032F62;--shiki-dark:#98C379;"> unable</span><span style="color:#032F62;--shiki-dark:#98C379;"> to</span><span style="color:#032F62;--shiki-dark:#98C379;"> create</span><span style="color:#032F62;--shiki-dark:#98C379;"> new</span><span style="color:#032F62;--shiki-dark:#98C379;"> native</span><span style="color:#032F62;--shiki-dark:#98C379;"> thread</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">  at</span><span style="color:#032F62;--shiki-dark:#98C379;"> java.lang.Thread.start0</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">Native</span><span style="color:#032F62;--shiki-dark:#98C379;"> Method</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">  at</span><span style="color:#032F62;--shiki-dark:#98C379;"> java.lang.Thread.start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">Thread.java:717</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">  at</span><span style="color:#032F62;--shiki-dark:#98C379;"> Test02.main</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">Test02.java:9</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="用户线程" tabindex="-1"><a class="header-anchor" href="#用户线程"><span>用户线程</span></a></h4><p>一般认为，一个线程只要不是内核线程，都是用户线程（User Thread，UT）</p><p>用户线程指完全建立再用户自己的程序线程库上，系统内核不能感知到存在的线程（用户线程的创建、同步、销毁和调度完全由用户程序完成，不需要内核的帮助）。</p><p>对比：</p><ul><li>系统线程上下文切换需要系统调度，代价高；用户线程不需要调用内核，操作快速且代价低，且能够支持规模更大的线程数量</li><li>系统线程调用方便，只要是支持多线程的系统都能轻松调起；用户线程调用复杂，需要用户程序自己处理线程的创建、销毁、切换和调度</li></ul><p>在 Java 1.2 之前 Thread 是用户线程，从 1.2 版本之后采用了内核线程，但如今考虑更好的程序性能，JDK 17 又推出 “协程/<s>纤程</s>/虚拟线程” 来辅助用户定义用户线程。</p><h3 id="并发、并行、串行" tabindex="-1"><a class="header-anchor" href="#并发、并行、串行"><span>并发、并行、串行</span></a></h3><p>并行 = 多个线程<strong>同时</strong>执行<strong>完整</strong>任务</p><p>串行 = 多个线程<strong>依次</strong>执行<strong>完整</strong>任务</p><p>并发 = 多个线程<strong>轮流</strong>执行<strong>部分</strong>任务</p><h3 id="线程数、cpu-的核心数" tabindex="-1"><a class="header-anchor" href="#线程数、cpu-的核心数"><span>线程数、CPU 的核心数</span></a></h3><p>线程是 CPU 调度的最小单位 —— 即同一时刻，一个 CPU 核心数量运行一个线程</p><h4 id="逻辑处理器-intel-超线程技术" tabindex="-1"><a class="header-anchor" href="#逻辑处理器-intel-超线程技术"><span>逻辑处理器（Intel 超线程技术）</span></a></h4><p>Intel 引入超线程技术后，产生了 “逻辑处理器” 的概念，即使 CPU 核心数与线程数可以形成 1:2 的关系。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在 Java 中使用 <code>Runtime.getRuntime().availableProcessors()</code> 可以获取当前的 CPU 核心数。 ❗ 实际上是逻辑处理器核心数</p></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>更多的线程一般意味着更多线程创建/销毁开销、更频繁的上下文切换，所以一般需要根据现有的 CPU 核心数量/逻辑处理器核心数量估算最大可并发的线程数。</p></div><h3 id="时间片、上下文切换" tabindex="-1"><a class="header-anchor" href="#时间片、上下文切换"><span>时间片、上下文切换</span></a></h3><p><strong>时间片</strong>： 为了让一个 CPU 核心并发执行多个线程，操作系统设计了 “时间片” 机制，即 CPU 核心轮流执行不同线程小段时间，让多个任务的状态在一个大时间内总能保持更新。</p><p><strong>上下文切换</strong>： 两个连续的时间片可能给到同一个线程，也可能给到不同的线程。当两个连续的时间片给到不同的线程后，CPU 核心执行到对应时间片时，由于执行的是另外的线程任务，就需要进行线程上下文的切换。</p><h2 id="thread-api" tabindex="-1"><a class="header-anchor" href="#thread-api"><span>Thread API</span></a></h2><p>start / run</p><p>setName / getName</p><p>sleep （💡 不释放锁）（推荐：TimeUnit） / interrupt / isInterrupted / interrupted</p><blockquote><p>参考：【Java 并发·08】线程中断 interrupt - https://www.bilibili.com/video/BV1CM4y157vc/</p></blockquote><p>yield （💡 不释放锁） —— 允许相同优先级其他线程抢占时间片。</p><p>setPriority / getPriority —— 优先级</p><p>join / isAlive —— 等待线程执行完成</p><p>setDaemon —— 守护线程</p><p>setUncaughtExceptionHandler —— 处理未捕获的异常</p><h3 id="线程中断-interrupt" tabindex="-1"><a class="header-anchor" href="#线程中断-interrupt"><span>线程中断（interrupt）</span></a></h3><p>Java Thread 有如下打断线程相关方法</p><p><code>public void interrupt()</code> 打断线程，线程抛出中断异常 （❗ 仅打上中断标记，不保证中断立即执行）</p><p><code>public boolean isInterrupted()</code> 判断当前线程是否被打断，不清除打断标记</p><p><code>public static boolean interrupted()</code> 判断当前线程是否被打断，清除打断标记</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;"> thread </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(() </span><span style="color:#D73A49;--shiki-dark:#C678DD;">-&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  while</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">true</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    System</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">out</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">println</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">currentThread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">isInterrupted</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">());</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // true</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">interrupted</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      System</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">out</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">println</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">currentThread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">isInterrupted</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">());</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // false</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      break</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 线程中断标记，不会主动中断线程，需要手动结束线程任务</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    System</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">out</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">println</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;定时任务...&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">})</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">interrupt</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 打上线程中断标记</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>Thread.sleep()</code> 中会调用 <code>Thread.interrupted()</code> 判断并消除中断标记</p></div><h3 id="线程状态" tabindex="-1"><a class="header-anchor" href="#线程状态"><span>线程状态</span></a></h3><blockquote><p>参考：</p><ul><li>https://www.cnblogs.com/i-code/p/13839020.html</li><li>https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=52</li></ul></blockquote><div class="hint-container tip"><p class="hint-container-title">提示</p><p>理解线程状态为了啥？ todo</p></div><p>在 JAVA 环境中，线程 Thread 有如下几个状态： （💡 通过 <code>Thread.State</code> 查看枚举） （💡 通过 <code>thread.getState()</code> 查看线程状态）</p><figure><img src="https://s2.loli.net/2024/05/26/vlUnRbkdoXBuTNE.png" alt="image.png" tabindex="0" loading="lazy"><figcaption>image.png</figcaption></figure><h3 id="callable、future" tabindex="-1"><a class="header-anchor" href="#callable、future"><span>Callable、Future</span></a></h3><p>获取线程返回值</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">FutureTask</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Integer</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> future </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> FutureTask</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Callable</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">Integer</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">) () </span><span style="color:#D73A49;--shiki-dark:#C678DD;">-&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> 5</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(future)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">try</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  Integer</span><span style="color:#24292E;--shiki-dark:#E06C75;"> value </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> future</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="異常抛出时机" tabindex="-1"><a class="header-anchor" href="#異常抛出时机"><span>異常抛出时机</span></a></h3><ul><li><p>无返回值用 execute 方法调用，异常马上在子线程抛出</p></li><li><p>有返回值用 submit 方法调用得到 future 类，异常在 <code>future.get</code> 时在主线程抛出</p></li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>异常抛出后，先给由 setUncaughtExceptionHandler 方法绑定的处理器处理</p></div><h3 id="locksupport" tabindex="-1"><a class="header-anchor" href="#locksupport"><span>LockSupport</span></a></h3><p>LockSupport 是 <code>java.util.concurrent.locks</code> 包下的一个类，是用来创建锁和其他同步类的基本线程阻塞工具类。</p><p>通过 <code>park</code> 和 <code>unpark</code> 方法可以实现线程调度中的 wait（等待） 和 notify（唤醒） 功能。</p><p>todo 具体使用方法 https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=47</p><h2 id="threadpool-api" tabindex="-1"><a class="header-anchor" href="#threadpool-api"><span>ThreadPool API</span></a></h2><p>Java 里的线程池顶级接口是 <code>java.util.concurrent.Executor</code> 一个执行线程的工具和 <code>java.util.concurrent.ExecutorService</code> 一个线程管理服务。</p>`,58),F=s("p",null,"配置参考：",-1),A={href:"https://www.bilibili.com/video/BV1xE421M78a/",target:"_blank",rel:"noopener noreferrer"},v=r(`<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">ExecutorService</span><span style="color:#24292E;--shiki-dark:#E06C75;"> threadPool </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> ThreadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#D19A66;">  10</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 💡 corePoolSize 核心线程数量 —— 创建，不回收</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#D19A66;">  20</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 💡 maximumPoolSize 最大线程数量 —— 创建，回收</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#D19A66;">  0L</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 💡 keepAliveTime 非核心线程存活时间</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  TimeUnit</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">SECONDS</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // 💡 workQueue 工作队列/阻塞队列 —— 超过核心线程数量后排队，队列满后才创建非核心线程处理任务</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // e.g.</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> ArrayBlockingQueue</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Runnable</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">3</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 基于数组的有界队列，先入先出（FIFO）原则排序</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // new LinkedBlockingQueue // 基于链表的有界阻塞队列（不设置大小时，默认为 Integer.MAX_VALUE），先入先出（FIFO）原则排序</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  Executors</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">defaultThreadFactory</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(),</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 💡 threadFactory 线程工厂 —— 可以用来绑定线程的异常处理器</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // 💡 handler 拒绝策略 —— 阻塞队列满了、最大线程数也满了，则有拒绝策略处理</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // e.g.</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // new ThreadPoolExecutor.AbortPolicy() // 丢弃任务并抛出 RejectedExecutionException 异常 ❗可能造成调用者线程终止</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  new</span><span style="color:#24292E;--shiki-dark:#E06C75;"> ThreadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">DiscardPolicy</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 丢弃任务不抛出异常</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // new ThreadPoolExecutor.DiscardOldestPolicy() // 丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // new ThreadPoolExecutor.CallerRunsPolicy() // 由调用线程处理该任务，e.g. 由 main 线程调用 runnable.run 方法</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">try</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  for</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#D73A49;--shiki-dark:#C678DD;">int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#005CC5;--shiki-dark:#D19A66;">1</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&lt;=</span><span style="color:#005CC5;--shiki-dark:#D19A66;">10</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#ABB2BF;">++</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">    // 💡无返回值使用 execute；有返回值使用 submit</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    threadPool</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">execute</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(() </span><span style="color:#D73A49;--shiki-dark:#C678DD;">-&gt;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">} </span><span style="color:#D73A49;--shiki-dark:#C678DD;">finally</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // threadPool.shutdownNow(); // （中断所有线程，）立即关闭线程池</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  threadPool</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">shutdown</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // （中断所有线程，）等待线程池中所有任务（正在执行的任务，队列中的任务）执行完毕后，关闭线程池</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  threadPool</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">awaitTermination</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Long</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">MAX_VALUE</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="color:#24292E;--shiki-dark:#E5C07B;">TimeUnit</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">SECONDS</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 等待线程池关闭，即线程池中所有线程执行完毕</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  threadPool</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">isTerminated</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 判断线程正真结束。true = 线程池中的所有线程执行完毕</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>线程池排队逻辑：</p><ul><li>核心线程空闲 —— 核心线程处理</li><li>核心线程满了 —— 排队</li><li>核心线程满了，队列满了 —— 非核心线程处理</li><li>核心线程满了，队列满了，非核心线程满了 —— 拒绝策略</li></ul><h3 id="executors" tabindex="-1"><a class="header-anchor" href="#executors"><span>Executors</span></a></h3><p>线程池有很多配置，为了简化配置，官方推荐使用 <code>java.util.concurrent.Exectors</code> 中的静态工厂类来生成一些常用的线程池。</p><ul><li>newFixedThreadPool —— 固定容量线程池</li><li>newCachedThreadPool —— 可缓存线程池。当需求较小，回收空闲线程；当需求过量，增加线程数（无上限）</li><li>newSingleThreadPoolExecutor —— 单线程 Executor</li><li>newScheduledThreadPool —— 固定容量线程池，且可延时启动任务和定时任务启动</li></ul><h3 id="非核心线程淘汰机制" tabindex="-1"><a class="header-anchor" href="#非核心线程淘汰机制"><span>非核心线程淘汰机制</span></a></h3><p>参考： https://www.bilibili.com/video/BV177421Z7as?p=29</p><p>todo 理解 <code>ThreadPoolExecutor.getTask</code> 逻辑</p><ul><li>time、timeout 作用</li><li>cas 竞争淘汰</li></ul><h3 id="拒绝策略" tabindex="-1"><a class="header-anchor" href="#拒绝策略"><span>拒绝策略</span></a></h3><p>当核心线程（corePoolSize）、任务队列（workQueue）、最大线程数（maximumPoolSize）都满了，就要执行 “拒绝策略”。</p><p>JDK 内置 4 种拒绝策略：</p><ul><li>AbortPolicy （默认） —— 丢弃任务，并抛出 RejectedExecutionException 异常 for 让程序员知道</li><li>CallerRunsPolicy —— 丢弃任务，不抛出异常 for 无关紧要的业务</li><li>DiscardOldestPolicy —— 丢弃任务队列最前的任务，将新任务放入队列末尾 for 重试业务</li><li>DiscardPolicy —— 任务调度线程来执行当前任务 for 让所有任务都能得到执行，而使用多线程只作为增加吞吐量的手段 so 适合大量计算类型的业务</li></ul><p>自定义拒绝策略：通过实现 <code>RejectExecutionHandler</code> 接口实现自定义拒绝策略。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">class</span><span style="color:#6F42C1;--shiki-dark:#E5C07B;"> MyRejectedExecutionHandler</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> implements</span><span style="color:#6F42C1;--shiki-dark:#E5C07B;"> RejectedExecutionHandler</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> rejectedExecution</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Runnable</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> r</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="color:#24292E;--shiki-dark:#E5C07B;">ThreadPoolExecutor</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> executor</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    try</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      executor</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getQueue</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">().</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">offer</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(r, </span><span style="color:#005CC5;--shiki-dark:#D19A66;">60</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="color:#24292E;--shiki-dark:#E5C07B;">TimeUnit</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">SECONDS</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">); </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 超时等待</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    } </span><span style="color:#D73A49;--shiki-dark:#C678DD;">catch</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">InterruptedExecution</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      e</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">printStackTrace</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>开源项目自定义拒绝策略：</p><ul><li>dubbo（<code>org.apache.dubbo.common.threadpool.support.AbortPolicyWithReport</code>） —— 当 dubbo 的工作线程触发了线程拒绝策略后，为了让使用者清楚触发线程拒绝策略的原因，拒绝策略做了三件事： <ol><li>输出告警日志 —— 内容包括：线程池的详细设置参数、线程池当前状态、拒绝的任务的详细信息</li><li>输出当前线程堆栈详情，将发生拒绝策略时的现场情况 dump 线程上下文信息到一个文件中</li><li>发送事件 onEvent</li><li>抛出拒绝执行异常，使本次任务失败（使用 JDK 默认拒绝策略的异常）</li></ol></li></ul><h3 id="扩展方法" tabindex="-1"><a class="header-anchor" href="#扩展方法"><span>扩展方法</span></a></h3><p>线程池里面提供了几个空方法（钩子方法）：</p><ul><li>beforeExecute</li><li>afterExecute</li><li>terminated</li></ul><p>通过这些钩子方法可以实现如线程池状态统计、日志输出、告警通知等功能。</p><p>todo https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=113</p><h2 id="线程安全" tabindex="-1"><a class="header-anchor" href="#线程安全"><span>线程安全</span></a></h2><p>线程安全 = 共享数据符合预期</p><ul><li>原子性 —— atomic</li><li>可见性 —— violated</li><li>有序性 —— 指令重排、内存屏障、synchronized</li></ul><h3 id="jmm-内存模型" tabindex="-1"><a class="header-anchor" href="#jmm-内存模型"><span>JMM 内存模型</span></a></h3><p>todo 可见性 violated、指令重排 内存屏障</p><h3 id="threadlocal" tabindex="-1"><a class="header-anchor" href="#threadlocal"><span>ThreadLocal</span></a></h3><p>todo</p><h4 id="问题-线程池中内存泄漏" tabindex="-1"><a class="header-anchor" href="#问题-线程池中内存泄漏"><span>问题：线程池中内存泄漏</span></a></h4><p>如果在线程池中使用 ThreadLocal 可能会造成内存泄漏。</p><p>可能造成内存泄漏的推论：</p><ol><li>线程对象是通过强引入指向 ThreadLocalMap 的</li><li>ThreadLocalMap 也是强引用指向内部的 Entry</li><li>内部的 Entry key 和 value 值分别是 “<code>Runnable</code> 中的 <code>new ThreadLocal</code> <code>ThreadLocal#xxxx</code>” 和 “<code>Runnable.run</code> 存入的值”</li><li>当 <code>Runnable.run</code> 结束后，<code>ThreadLocal#xxxx</code> 依然被 Entry 强引用，但以无其他方式获取它</li><li>因为线程池该线程可能长时间存在，从而导致 Entry 这块内存无法被 gc 回收，导致内存泄漏</li></ol><p>解决方法：</p><p>在线程池中，使用了 ThreadLocal 对象后，手动调用 ThreadLocal 的 remove 方法，手动清除 Entry 对象。</p><h4 id="inheritablethreadlocal" tabindex="-1"><a class="header-anchor" href="#inheritablethreadlocal"><span>InheritableThreadLocal</span></a></h4><p>解决 ThreadLocal 无法获取父线程中的 ThreadLocal 的值的问题</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">InheritableThreadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">String</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> threadLocal </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> InheritableThreadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">threadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;test&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;"> thread </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#D73A49;--shiki-dark:#C678DD;">new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Runnable</span><span style="color:#24292E;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> run</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    String</span><span style="color:#24292E;--shiki-dark:#E06C75;"> value</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> threadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">})</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sleep</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>无法感知到父线程中途修改 ThreadLocal 的值</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">InheritableThreadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">String</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> threadLocal </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> InheritableThreadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">threadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;test&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">for</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#D73A49;--shiki-dark:#C678DD;">int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#005CC5;--shiki-dark:#D19A66;">0</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#005CC5;--shiki-dark:#D19A66;">10</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#ABB2BF;">++</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">==</span><span style="color:#005CC5;--shiki-dark:#D19A66;">5</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    threadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;test5&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;"> thread </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#D73A49;--shiki-dark:#C678DD;">new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Runnable</span><span style="color:#24292E;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    @</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Override</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> run</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      String</span><span style="color:#24292E;--shiki-dark:#E06C75;"> value</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> threadLocal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(); </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 依然是 test</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // ...</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了解决这个问题，可以使用阿里开源组件 TransmittableThreadLocal</p></div><h3 id="原子类-atomic" tabindex="-1"><a class="header-anchor" href="#原子类-atomic"><span>原子类（atomic）</span></a></h3><p>在 <code>java.util.concurrent.atomic</code> 包中</p><table><thead><tr><th>类型</th><th>具体类</th></tr></thead><tbody><tr><td>基本类型</td><td>AtomicInteger、AtomicLong、AtomicBoolean</td></tr><tr><td>引用类型</td><td>AtomicReference、AtomicStampedReference、AtomicMarkableReference （涉及 CAS）</td></tr><tr><td>数组类型</td><td>AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</td></tr><tr><td>升级类型</td><td>AtomicIntegerFieldUpdater、AtomicLongFieldUpdater、AtomicReferenceFieldUpdater</td></tr><tr><td>累加器 Adder</td><td>LongAdder、DoubleAdder</td></tr><tr><td>积累器 Accumulator <br> 可自定义累加方式</td><td>LongAccumulator、DoubleAccumulator</td></tr></tbody></table><div class="hint-container tip"><p class="hint-container-title">提示</p><p>lazySet 不会保证可见性（没有加内存屏障）</p></div><h3 id="aba-问题" tabindex="-1"><a class="header-anchor" href="#aba-问题"><span>ABA 问题</span></a></h3><p>并发场景下，存在上下文数值被其他线程篡改的情况。</p><p>这种情况通过 “原子类 + 版本号” 的方式识别。</p><p>todo 例子 AtomicStampedReference</p><h3 id="锁" tabindex="-1"><a class="header-anchor" href="#锁"><span>锁</span></a></h3><h4 id="悲观锁-互斥锁-阻塞锁" tabindex="-1"><a class="header-anchor" href="#悲观锁-互斥锁-阻塞锁"><span>悲观锁/互斥锁/阻塞锁</span></a></h4><p>悲观锁 —— 获取锁/释放锁均有 “线程状态的切换”，这会消耗性能</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>所谓 “线程状态切换” 即： 让没有得到锁资源的线程进入 BLOCK 状态，然后在争夺到锁资源后恢复为 RUNNABLE 状态。 这个过程涉及到操作系统用户模式和内核模式的转换，所以代价比较高。</p></div><h5 id="synchronized-关键字" tabindex="-1"><a class="header-anchor" href="#synchronized-关键字"><span>synchronized 关键字</span></a></h5><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> synchronized</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> test</span><span style="color:#24292E;--shiki-dark:#E06C75;">() throws InterruptedException { </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 💡线程状态切换</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#E5C07B;">  this</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">wait</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#005CC5;--shiki-dark:#E5C07B;">  this</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">notify</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 不能指定线程唤醒</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="reentrantlock-类" tabindex="-1"><a class="header-anchor" href="#reentrantlock-类"><span>ReentrantLock 类</span></a></h5><p><code>ReentrantLock lock = new ReentrantLock()</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">ReentrantLock</span><span style="color:#24292E;--shiki-dark:#E06C75;"> lock </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> ReentrantLock</span><span style="color:#24292E;--shiki-dark:#E06C75;">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">lock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">lock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> // 💡线程状态切换</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">con</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">wait</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">con</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">signal</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">lock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">unlock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="乐观锁-非阻塞锁" tabindex="-1"><a class="header-anchor" href="#乐观锁-非阻塞锁"><span>乐观锁/非阻塞锁</span></a></h4><p>乐观锁 —— 通过系统指令，保证修改某变量状态时是原子性的，从而通过判断该变量状态，判断是否进入锁</p><h5 id="自旋锁-spinlock-cas-compare-and-swap" tabindex="-1"><a class="header-anchor" href="#自旋锁-spinlock-cas-compare-and-swap"><span>自旋锁（spinlock）/CAS（Compare and Swap）</span></a></h5><p>自旋锁是在当前线程上，不停地循环判断原子变量的状态，判断是否进入锁。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>自旋锁通过循环将线程卡在某段代码上，从而避免线程状态的改变为 BLOCK，所以响应速度更快。 但当线程数不停增加时，因为每个线程都需要执行，占用 CPU 时间，所以性能会下降明显。 所以只有当线程竞争不激烈，并且保持锁的时间短时，适合使用自旋锁。</p></div><p>e.g.</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">for</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;;</span><span style="color:#24292E;--shiki-dark:#E06C75;">) { </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 自旋</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">  // 使用操作系统指令保证 compare and set 这两步操作的原子性</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  if</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Unsafe</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getUnsafe</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">().</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">compareAndSwapInt</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#E06C75;">) { </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 只有一个线程能进入</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>or</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// 使用了CAS原子操作，lock函数将owner设置为当前线程，并且预测原来的值为空。unlock函数将owner设置为null，并且预测值为当前线程</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="color:#6F42C1;--shiki-dark:#E5C07B;"> SpinLock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> AtomicReference</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> sign </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> AtomicReference</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> lock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;"> current</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">currentThread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    while</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">!</span><span style="color:#24292E;--shiki-dark:#E5C07B;">sign</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">compareAndSet</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">null</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, current)) {}</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> unlock</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;"> current</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">currentThread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    sign</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">compareAndSet</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(current, </span><span style="color:#005CC5;--shiki-dark:#D19A66;">null</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="偏向锁、轻量级锁、重量级锁" tabindex="-1"><a class="header-anchor" href="#偏向锁、轻量级锁、重量级锁"><span>偏向锁、轻量级锁、重量级锁</span></a></h4><h5 id="synchronized-锁升级问题" tabindex="-1"><a class="header-anchor" href="#synchronized-锁升级问题"><span>synchronized 锁升级问题</span></a></h5><p>在 JDK 1.6 之前，JVM 通过内核态的 <strong>管程（Monitor，监视器，对象锁）</strong> 来实现 synchronized 锁的互斥。这种锁属于重量级锁，响应效率低。</p><div class="hint-container info"><p class="hint-container-title">相关信息</p><p>管程（Monitor，监视器）是指管理共享变量操作的过程，让它们支持并发时的线程安全。（简单来说就是两个作用：同步和互斥） Java 中的 <code>synchronized</code>、<code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code> 均是管程技术的一部分。</p><p>💡 源码： Hotspot jdk 1.6 c++</p></div><p>在 JDK 1.6 之后，JVM 为了提高锁的获取与释放效率，对 synchronized 的实现进行优化，引入了 “<strong>偏向锁</strong>” 和 “<strong>轻量级锁</strong>”。 （此时，锁有四种级别，级别从低到高依次为：<strong>无锁</strong>、<strong>偏向锁</strong>、<strong>轻量级锁</strong>、<strong>重量级锁</strong>） 随着锁竞争加剧，锁级别会逐渐升级。 （锁升级过程不可逆，即：锁级别只升不降）</p><p>todo markWord pol</p><p>todo 四个级别</p><h4 id="可重入锁-reentrant-递归锁" tabindex="-1"><a class="header-anchor" href="#可重入锁-reentrant-递归锁"><span>可重入锁（reentrant）/递归锁</span></a></h4><p>可重入锁，也叫做递归锁，指的是同一线程 外层函数获得锁之后 ，内层递归函数仍然有获取该锁的代码，但不受影响。 在 JDK 中 <code>ReentrantLock</code> 和 <code>synchronized</code> 都是可重入锁。</p>`,75),C=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," Test"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," implements"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," Runnable"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"  ReentrantLock"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," lock "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"="),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," ReentrantLock"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"    set"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"unlock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," set"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"unlock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Override")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," run"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"    get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),b=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," Test"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," implements"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," Runnable"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," synchronized"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"    set"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," synchronized"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," set"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"}),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Override")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," run"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"    get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),D=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," SpinLock1"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  private"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," AtomicReference"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Thread"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},">"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," owner "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"="),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," new"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," AtomicReference"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<>"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  private"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," int"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," count "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"="),s("span",{style:{color:"#005CC5","--shiki-dark":"#D19A66"}}," 0"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," lock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    Thread"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," current"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}}," ="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," Thread"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"currentThread"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"    if"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," (current "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"=="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," owner"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()) {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      count"),s("span",{style:{color:"#D73A49","--shiki-dark":"#ABB2BF"}},"++"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      return"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"    }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"    while"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"!"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"owner"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"compareAndSet"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#005CC5","--shiki-dark":"#D19A66"}},"null"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},", current)) {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"      // wait ... or else cpu busy")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"    }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," unlock"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    Thread"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," current"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}}," ="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," Thread"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"currentThread"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"    if"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(current "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"=="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," owner"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"get"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()) {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      if"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(count"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"!="),s("span",{style:{color:"#005CC5","--shiki-dark":"#D19A66"}},"0"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},") {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"        count"),s("span",{style:{color:"#D73A49","--shiki-dark":"#ABB2BF"}},"--"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      } "),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"else"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"        owner"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"compareAndSet"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(current, "),s("span",{style:{color:"#005CC5","--shiki-dark":"#D19A66"}},"null"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},");")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"    }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),m=r(`<h4 id="reentrantlock-使用" tabindex="-1"><a class="header-anchor" href="#reentrantlock-使用"><span>ReentrantLock 使用</span></a></h4><p>todo timeout</p><p>todo trylock —— 防止获取锁失败后一直等待，可以自定义获取锁失败后的处理</p><p>todo lockInterruptibly —— 等待过程中中断</p><h4 id="公平锁、非公平锁" tabindex="-1"><a class="header-anchor" href="#公平锁、非公平锁"><span>公平锁、非公平锁</span></a></h4><p>概念：</p><ul><li>非公平 —— 优先将锁给统一线程的任务 💡 非公平锁能减少线程上下文切换的开销，理论上性能更好，所以锁默认都是非公平的</li><li>公平 —— 不同线程获取锁机会一样</li></ul><p>e.g.</p><ul><li>synchronized 非公平</li><li>ReentrantLock 可公平、可非公平 <code>new ReentrantLock(true) ; // fair true/false 默认 false</code></li></ul><h2 id="生产者-消费者模型" tabindex="-1"><a class="header-anchor" href="#生产者-消费者模型"><span>生产者/消费者模型</span></a></h2><p>todo</p><h2 id="协程-虚拟线程" tabindex="-1"><a class="header-anchor" href="#协程-虚拟线程"><span>协程/虚拟线程</span></a></h2><p>Java 19 引入虚拟线程概念，Java 21 落地虚拟线程。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>JVM 使用轻量级的任务队列来调度虚拟线程，实现多个协同任务的调度，这避免使用多个真实线程来调度多个协同的任务，从而避免线程间上下文切换的带来的系统开销。</p></div><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题</span></a></h2><h3 id="问题-concurrenthashmap-实现原理" tabindex="-1"><a class="header-anchor" href="#问题-concurrenthashmap-实现原理"><span>问题：ConcurrentHashMap 实现原理</span></a></h3><p>ConcurrentHashMap 数据结构如下：</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span>Segment[] （💡 Segment 继承 ReentrantLock 实现分段线程安全）</span></span>
<span class="line"><span>0 - HashEntry[] - HashEntry1,HashEntry2,... （单向链表）</span></span>
<span class="line"><span>1 - HashEntry[]</span></span>
<span class="line"><span>2 - HashEntry[]</span></span>
<span class="line"><span>3 - HashEntry[]</span></span>
<span class="line"><span>4 - HashEntry[]</span></span>
<span class="line"><span>5 - HashEntry[]</span></span>
<span class="line"><span>6 - HashEntry[]</span></span>
<span class="line"><span>7 - HashEntry[]</span></span>
<span class="line"><span>8 - HashEntry[]</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>16 （默认 16 个 segment 锁，相当于最大支持 16 个并发 put 操作）</span></span>
<span class="line"><span></span></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>与 HashMap 一样，在 JDK 1.8 后，对碰撞增加了 “红黑树” 的处理。</p></div>`,19),f={class:"hint-container tip"},g=s("p",{class:"hint-container-title"},"提示",-1),x={href:"https://www.infoq.cn/article/ConcurrentHashMap",target:"_blank",rel:"noopener noreferrer"},T=s("ul",null,[s("li",null,"segments 数组的长度 ssize 通过 concurrencyLevel 计算得出"),s("li",null,"必须保证 segments 数组的长度是 2 的 N 次方（power-of-two size）"),s("li",null,"e.g. 假如 concurrencyLevel 等于 14，15 或 16，ssize 都会等于 16，即容器里锁的个数也是 16")],-1),w=r(`<h3 id="问题-实务多线程失效-❗-解决方案有问题" tabindex="-1"><a class="header-anchor" href="#问题-实务多线程失效-❗-解决方案有问题"><span>问题：实务多线程失效（❗ 解决方案有问题）</span></a></h3><p>todo 移到 spring 并在这里提示</p><p>问题：每个线程中的数据库连接（CurrentConnection）是不同的、独立的</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Transactional</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> transactionAsyncFail</span><span style="color:#24292E;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(() </span><span style="color:#D73A49;--shiki-dark:#C678DD;">-&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">    addUser</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">1</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  })</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">  addUser</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">3</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  throw</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;手动回滚&quot;</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>解决：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> transactionAsyncSuccess</span><span style="color:#24292E;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> size </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> 10</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  CyclicBarrier</span><span style="color:#24292E;--shiki-dark:#E06C75;"> barrier </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> CyclicBarrier</span><span style="color:#24292E;--shiki-dark:#E06C75;">(size)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  AtomicReference</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Boolean</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> roolback </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> AtomicReference</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">false</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  for</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#D73A49;--shiki-dark:#C678DD;">int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#005CC5;--shiki-dark:#D19A66;">0</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#24292E;--shiki-dark:#E06C75;">size</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#D73A49;--shiki-dark:#ABB2BF;">++</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> currentNum </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#24292E;--shiki-dark:#E06C75;"> i</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> Thread</span><span style="color:#24292E;--shiki-dark:#E06C75;">(() </span><span style="color:#D73A49;--shiki-dark:#C678DD;">-&gt;</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // 手动开启事务</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      TransactionStatus</span><span style="color:#24292E;--shiki-dark:#E06C75;"> transaction </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> transactionManager</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getTransaction</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(transactionDefinition);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      try</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">        // insert 操作，如果插入数据 &lt; 1 则异常</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">addUser</span><span style="color:#24292E;--shiki-dark:#E06C75;">(currentNum) </span><span style="color:#D73A49;--shiki-dark:#56B6C2;">&lt;</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> 1</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">          log</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">..</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">info</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;手动异常&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">          throw</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;插入数据失败&quot;</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">        }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">      } </span><span style="color:#D73A49;--shiki-dark:#C678DD;">catch</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">Exception</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">        // 如果当前线程执行异常，则设置回滚标志</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">        rollback</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">true</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // 等待所有线程的事务结束</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      try</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">        barrier</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">await</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">      } </span><span style="color:#D73A49;--shiki-dark:#C678DD;">catch</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">InterruptedException</span><span style="color:#24292E;--shiki-dark:#E06C75;"> | </span><span style="color:#24292E;--shiki-dark:#E5C07B;">BrokenBarrierException</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">        throw</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="color:#24292E;--shiki-dark:#E06C75;">(e)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">      }</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // 如果标志需要回滚，则回滚</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      log</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">info</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;我执行了{}&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, currentNum);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      if</span><span style="color:#24292E;--shiki-dark:#E06C75;"> (</span><span style="color:#24292E;--shiki-dark:#E5C07B;">rollback</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">        transactionManager</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">rollback</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(transaction);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">        log</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">info</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;rollback for {}&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">, currentNum);</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">        return</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      transactionManager</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">commit</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(transaction);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">    })</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">start</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  try</span><span style="color:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    Thread</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">sleep</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">1000</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  } </span><span style="color:#D73A49;--shiki-dark:#C678DD;">catch</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">InterruptedException</span><span style="color:#E36209;--shiki-dark:#E06C75;font-style:inherit;--shiki-dark-font-style:italic;"> e</span><span style="color:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">    throw</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="color:#24292E;--shiki-dark:#E06C75;">(e)</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">  log</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">info</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="color:#032F62;--shiki-dark:#98C379;">&quot;hello&quot;</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>坑：</p><ol><li>多线程长时间占用，线程池占满</li><li>死锁</li><li>干扰实际的数据库实务间的隔离性</li><li>可以用 “分布式实务” 或 “最终一致” 解决</li></ol><h3 id="问题-动态线程池-with-nacos" tabindex="-1"><a class="header-anchor" href="#问题-动态线程池-with-nacos"><span>问题：动态线程池 with Nacos</span></a></h3><p>todo https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=108</p><p>所谓 “动态线程池” 指在不重启服务的情况下，改变线程池核心线程数量、最大线程数量、队列容量等。</p><h4 id="动态修改配置" tabindex="-1"><a class="header-anchor" href="#动态修改配置"><span>动态修改配置</span></a></h4>`,12),P={href:"https://github.com/alibaba/spring-cloud-alibaba/wiki/",target:"_blank",rel:"noopener noreferrer"},j=s("li",null,"Spring Boot 2.6.3",-1),_=s("li",null,"Spring Cloud 2021.0.1",-1),S=s("li",null,"Spring Cloud Alibaba 2021.0.1.0",-1),L={href:"https://nacos.io/",target:"_blank",rel:"noopener noreferrer"},R=r(`<div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6F42C1;--shiki-dark:#61AFEF;">./startup.sh</span><span style="color:#005CC5;--shiki-dark:#D19A66;"> -m</span><span style="color:#032F62;--shiki-dark:#98C379;"> standalone</span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> # 单机启动，否则以集群方式启动需要额外配置，麻烦</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"># 日志： \${NACOS_HOME}/logs/start.out</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"># 访问： http://ip:8848/nacos 默认用户/密码： nacos/nacos</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-properties line-numbers-mode" data-ext="properties" data-title="application.properties"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">server.port</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">7070</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">spring.application.name</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">dynamic-thread-pool</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">spring.cloud.nacos.config.server-addr</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">8.142.44.107:8848</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">spring.cloud.nacos.config.name</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">dynamic-thread-pool</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">spring.cloud.nacos.username</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">nacos</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">spring.cloud.nacos.password</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">=</span><span style="color:#24292E;--shiki-dark:#98C379;">nacos</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="ThreadPoolConfig.java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * 添加下面配置，会生成对自定义配置文件的提示</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * &lt;dependency&gt;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> *  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> *  &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> *  &lt;optional&gt;true&lt;/optional&gt;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * &lt;/dependency&gt;</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> *</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * 默认配置</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * thread.pool.core-pool-size=16</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * thread.pool.maximum-pool-size=16</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> * thread.pool.work-queue-size=1024</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Data</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Component</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">ConfigurationProperties</span><span style="color:#24292E;--shiki-dark:#E06C75;">(</span><span style="color:#005CC5;--shiki-dark:#D19A66;">perfix</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#032F62;--shiki-dark:#98C379;"> &quot;thread.pool&quot;</span><span style="color:#24292E;--shiki-dark:#E06C75;">)</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="color:#6F42C1;--shiki-dark:#E5C07B;"> ThreadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> corePoolSize</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> maximumPoolSize</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> long</span><span style="color:#24292E;--shiki-dark:#E06C75;"> keepAliveTime</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="color:#24292E;--shiki-dark:#E06C75;"> workQueue</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="ThreadPoolConfig.java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Configuration</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="color:#6F42C1;--shiki-dark:#E5C07B;"> ThreadPoolConfig</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Autowired</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  private</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> ThreadPoolProperties</span><span style="color:#24292E;--shiki-dark:#E06C75;"> threadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  @</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">  public</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> ThreadPoolExecutor</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> threadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">    ThreadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#E06C75;"> threadPoolExecutor</span><span style="color:#D73A49;--shiki-dark:#56B6C2;"> =</span><span style="color:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> ThreadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      threadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getCorePoolSize</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      threadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getMaximumPoolSize</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      threadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getKeepAliveTime</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      TimeUnit</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#24292E;--shiki-dark:#E5C07B;">SECONDS</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      new</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> ArrayBlockingQueue</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Runnable</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">&gt;(</span><span style="color:#24292E;--shiki-dark:#E5C07B;">threadPoolProperties</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">getWorkQueueSize</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()),</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#E5C07B;">      Executors</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">defaultThreadFactory</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">      // Executors.privilegedThreadFactory(),</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">      new</span><span style="color:#24292E;--shiki-dark:#ABB2BF;"> ThreadPoolExecutor.</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;">DiscardPolicy</span><span style="color:#24292E;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方法一： <code>@RefreshScope</code> —— 刷新 bean 配置</p><div class="language-java line-numbers-mode" data-ext="java" data-title="ThreadPoolConfig.java"><pre class="shiki shiki-themes github-light one-dark-pro" style="background-color:#fff;--shiki-dark-bg:#282c34;color:#24292e;--shiki-dark:#abb2bf;" tabindex="0"><code><span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">RefreshScope</span></span>
<span class="line"><span style="color:#24292E;--shiki-dark:#ABB2BF;">@</span><span style="color:#D73A49;--shiki-dark:#E5C07B;">Bean</span></span>
<span class="line"><span style="color:#D73A49;--shiki-dark:#C678DD;">public</span><span style="color:#24292E;--shiki-dark:#E5C07B;"> ThreadPoolExecutor</span><span style="color:#6F42C1;--shiki-dark:#61AFEF;"> threadPoolExecutor</span><span style="color:#24292E;--shiki-dark:#E06C75;">() { </span><span style="color:#6A737D;--shiki-dark:#7F848E;font-style:inherit;--shiki-dark-font-style:italic;">// ...</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方法二： 自己编写刷新代码</p>`,7),z=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"ThreadPoolConfig.java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"@"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Bean")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," ThreadPoolExecutor"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," threadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"  ThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," threadPoolExecutor "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"="),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," DynamicThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"( "),s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"// DynamicThreadPoolExecutor 自定义类")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),I=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"DynamicThreadPoolExecutor.java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," DynamicThreadPoolExecutor"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," extends"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," ThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"  // ... super method")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),M=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"DynamicThreadPoolExecutorManager"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"@"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Component")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," DynamicThreadPoolExecutorManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Autowired")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  private"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," ApplicationContext"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," applicationContext"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," synchronized"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," refreshThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"Properties"),s("span",{style:{color:"#E36209","--shiki-dark":"#E06C75","font-style":"inherit","--shiki-dark-font-style":"italic"}}," properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," { "),s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"// 💡加锁，避免ABA")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    applicationContext"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getBeansOfType"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"DynamicThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"class"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"forEach"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"((beanName, executor) "),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"->"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      executor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"setCorePoolSize"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"Integer"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"parseInt"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getProperty"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#032F62","--shiki-dark":"#98C379"}},'"thread.pool.core-pool-size"'),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")));")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      executor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"setMaximumPoolSize"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"Integer"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"parseInt"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getProperty"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#032F62","--shiki-dark":"#98C379"}},'"thread.pool.maximum-pool-size"'),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")));")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"      // 自定义队列 because of 队列无法通过线程池设置大小")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      if"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," ("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"executor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"() "),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"instanceof"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," ResizeLinkedBlockingQueue) {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"        ((ResizeLinkedBlockingQueue) "),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"executor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"())."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"updateCapacity"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getProperty"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#032F62","--shiki-dark":"#98C379"}},'"work-queue-size"'),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"));")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"    });")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),U=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," ResizeLinkedBlockingQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"E"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},">"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," extends"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," AbstractQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"E"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},">"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," implements"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," BlockingQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"E"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},">,"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," java.io."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}},"Serializable"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"  // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," updateCapacity"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"int"),s("span",{style:{color:"#E36209","--shiki-dark":"#E06C75","font-style":"inherit","--shiki-dark-font-style":"italic"}}," size"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // ...")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),J=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"ThreadPoolConfig.java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Bean")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," ThreadPoolExecutor"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," threadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    ThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," threadPoolExecutor "),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}},"="),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," ThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"(")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      threadPoolProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getCorePoolSize"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      threadPoolProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getMaximumPoolSize"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      threadPoolProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getKeepAliveTime"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      TimeUnit"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"SECONDS"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},",")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      new"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," ResizeLinkedBlockingQueue"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"<"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Runnable"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},">"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"threadPoolProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getWorkQueueSize"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},")"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},","),s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}}," // 💡注入自定义队列")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"      Executors"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"defaultThreadFactory"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"      // Executors.privilegedThreadFactory(),")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      new"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," ThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"DiscardPolicy"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"    )")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}},"  }")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),N=s("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"NacosConfigListener.java"},[s("pre",{class:"shiki shiki-themes github-light one-dark-pro",style:{"background-color":"#fff","--shiki-dark-bg":"#282c34",color:"#24292e","--shiki-dark":"#abb2bf"},tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"@"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Component")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," class"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," NacosConfigListener"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," implements"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#E5C07B"}}," ApplicationRunner"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Atuowired")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  private"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," NacosConfigManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," nacosConfigManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Autowired")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  private"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," DynamicThreadPoolExecutorManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," dynamicThreadPoolExecutorManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Override")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"  public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," run"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"ApplicationArguments"),s("span",{style:{color:"#E36209","--shiki-dark":"#E06C75","font-style":"inherit","--shiki-dark-font-style":"italic"}}," args"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},")"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," throws"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," Execption"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"    // 开始监听 nacos 的配置更新")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    String"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," dataId"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}}," ="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," nacosConfigManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getNacosConfigProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getName"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    String"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," group"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}}," ="),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," nacosConfigManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getNacosConfigProperties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getGroup"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"    nacosConfigManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"getConfigService"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"addListener"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(dataId, group, "),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," Listener"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"() {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Override")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      public"),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}}," Executor"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," getExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"()"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"        return"),s("span",{style:{color:"#005CC5","--shiki-dark":"#D19A66"}}," null"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},";")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"      // 更新后的配置信息在此方法中接收")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      @"),s("span",{style:{color:"#D73A49","--shiki-dark":"#E5C07B"}},"Override")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"      public"),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," void"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," receiveConfigInfo"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"        String"),s("span",{style:{color:"#E36209","--shiki-dark":"#E06C75","font-style":"inherit","--shiki-dark-font-style":"italic"}}," configInfo"),s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}}," // 更新后的配置信息")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      )"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#6A737D","--shiki-dark":"#7F848E","font-style":"inherit","--shiki-dark-font-style":"italic"}},"        // 刷新我们的线程池配置类")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"        Properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#E06C75"}}," properties"),s("span",{style:{color:"#D73A49","--shiki-dark":"#56B6C2"}}," ="),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}}," new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," Properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"        try"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"          properties"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"load"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"("),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"new"),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}}," StringReader"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(configInfo));")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"        } "),s("span",{style:{color:"#D73A49","--shiki-dark":"#C678DD"}},"catch"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}}," ("),s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"IOException"),s("span",{style:{color:"#E36209","--shiki-dark":"#E06C75","font-style":"inherit","--shiki-dark-font-style":"italic"}}," e"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},") {")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"          e"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"printStackTrace"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"();")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"        }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#E5C07B"}},"        dynamicThreadPoolExecutorManager"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"."),s("span",{style:{color:"#6F42C1","--shiki-dark":"#61AFEF"}},"refreshThreadPoolExecutor"),s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"(properties);")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"      }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"    })")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"  }")]),a(`
`),s("span",{class:"line"},[s("span",{style:{color:"#24292E","--shiki-dark":"#ABB2BF"}},"}")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),q=s("h4",{id:"队列缩容处理",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#队列缩容处理"},[s("span",null,"队列缩容处理")])],-1),O=s("p",null,"todo 多余线程的处理",-1),H=s("h4",{id:"开源框架",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#开源框架"},[s("span",null,"开源框架")])],-1),V=s("ul",null,[s("li",null,[s("code",null,"dynamic-tp"),a(" —— 美团开源的动态线程池，支持通过 nacos 配置中心配置线程池，对线程池进行扩缩容。")])],-1);function K(Q,Z){const o=t("ExternalLinkIcon"),p=t("Tabs");return k(),d("div",null,[y,s("blockquote",null,[B,s("p",null,[a("参考： "),s("a",E,[a("https://www.bilibili.com/video/BV1Bw4m1Z7eg?p=11"),e(o)])])]),u,s("blockquote",null,[F,s("ul",null,[s("li",null,[s("a",A,[a("https://www.bilibili.com/video/BV1xE421M78a/"),e(o)])])])]),v,e(p,{id:"734",data:[{id:"ReentrantLock 示例"},{id:"synchronized 示例"},{id:"自定义"}]},{title0:i(({value:n,isActive:l})=>[a("ReentrantLock 示例")]),title1:i(({value:n,isActive:l})=>[a("synchronized 示例")]),title2:i(({value:n,isActive:l})=>[a("自定义")]),tab0:i(({value:n,isActive:l})=>[C]),tab1:i(({value:n,isActive:l})=>[b]),tab2:i(({value:n,isActive:l})=>[D]),_:1}),m,s("div",f,[g,s("p",null,[a("concurrencyLevel 配置与 segment 数量的关系： "),s("a",x,[a("https://www.infoq.cn/article/ConcurrentHashMap"),e(o)])]),T]),w,s("p",null,[a("环境：（基于 "),s("a",P,[a("Spring Cloud Alibaba 版本说明"),e(o)]),a("）")]),s("ul",null,[j,_,S,s("li",null,[s("a",L,[a("Nacos"),e(o)]),a(" 1.4.2")])]),R,e(p,{id:"931",data:[{id:"注册自定义线程池"},{id:"实现自定义线程池"},{id:"实现自定义动态线程池管理器"},{id:"实现自定义队列"},{id:"配置 nacos 监听器"}]},{title0:i(({value:n,isActive:l})=>[a("注册自定义线程池")]),title1:i(({value:n,isActive:l})=>[a("实现自定义线程池")]),title2:i(({value:n,isActive:l})=>[a("实现自定义动态线程池管理器")]),title3:i(({value:n,isActive:l})=>[a("实现自定义队列")]),title4:i(({value:n,isActive:l})=>[a("配置 nacos 监听器")]),tab0:i(({value:n,isActive:l})=>[z]),tab1:i(({value:n,isActive:l})=>[I]),tab2:i(({value:n,isActive:l})=>[M]),tab3:i(({value:n,isActive:l})=>[U,J]),tab4:i(({value:n,isActive:l})=>[N]),_:1}),q,O,H,V])}const W=c(h,[["render",K],["__file","jdk-thread.html.vue"]]),G=JSON.parse('{"path":"/zh/dev-java-commonsense/jdk-thread.html","title":"JDK thread 功能","lang":"zh-CN","frontmatter":{"title":"JDK thread 功能","date":"2024-05-24T00:00:00.000Z","tag":["java","thread"],"order":66,"description":"概念 JUC JUC java.util.concurrent 缩写 并发场景进行多线程编程的工具类 进程、线程、协程 进程 —— 一个应用，系统资源分配单位 线程 —— 一个应用的其中一个任务，共享进程资源 协程/虚拟线程（Visual Thread） —— 在一个任务中，实现多任务有序的协作开展任务 一个线程中可以有多个虚拟线程 不由系统管理，由 ...","head":[["meta",{"property":"og:url","content":"https://lawsssscat.github.io/blog/zh/blog/zh/dev-java-commonsense/jdk-thread.html"}],["meta",{"property":"og:site_name","content":"个人博客"}],["meta",{"property":"og:title","content":"JDK thread 功能"}],["meta",{"property":"og:description","content":"概念 JUC JUC java.util.concurrent 缩写 并发场景进行多线程编程的工具类 进程、线程、协程 进程 —— 一个应用，系统资源分配单位 线程 —— 一个应用的其中一个任务，共享进程资源 协程/虚拟线程（Visual Thread） —— 在一个任务中，实现多任务有序的协作开展任务 一个线程中可以有多个虚拟线程 不由系统管理，由 ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://s2.loli.net/2024/05/26/vlUnRbkdoXBuTNE.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-06-15T17:37:40.000Z"}],["meta",{"property":"article:author","content":"Steven"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"thread"}],["meta",{"property":"article:published_time","content":"2024-05-24T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-06-15T17:37:40.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"JDK thread 功能\\",\\"image\\":[\\"https://s2.loli.net/2024/05/26/vlUnRbkdoXBuTNE.png\\"],\\"datePublished\\":\\"2024-05-24T00:00:00.000Z\\",\\"dateModified\\":\\"2024-06-15T17:37:40.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Steven\\",\\"url\\":\\"https://github.com/LawssssCat/\\"}]}"]]},"headers":[{"level":2,"title":"概念","slug":"概念","link":"#概念","children":[{"level":3,"title":"JUC","slug":"juc","link":"#juc","children":[]},{"level":3,"title":"进程、线程、协程","slug":"进程、线程、协程","link":"#进程、线程、协程","children":[]},{"level":3,"title":"并发、并行、串行","slug":"并发、并行、串行","link":"#并发、并行、串行","children":[]},{"level":3,"title":"线程数、CPU 的核心数","slug":"线程数、cpu-的核心数","link":"#线程数、cpu-的核心数","children":[]},{"level":3,"title":"时间片、上下文切换","slug":"时间片、上下文切换","link":"#时间片、上下文切换","children":[]}]},{"level":2,"title":"Thread API","slug":"thread-api","link":"#thread-api","children":[{"level":3,"title":"线程中断（interrupt）","slug":"线程中断-interrupt","link":"#线程中断-interrupt","children":[]},{"level":3,"title":"线程状态","slug":"线程状态","link":"#线程状态","children":[]},{"level":3,"title":"Callable、Future","slug":"callable、future","link":"#callable、future","children":[]},{"level":3,"title":"異常抛出时机","slug":"異常抛出时机","link":"#異常抛出时机","children":[]},{"level":3,"title":"LockSupport","slug":"locksupport","link":"#locksupport","children":[]}]},{"level":2,"title":"ThreadPool API","slug":"threadpool-api","link":"#threadpool-api","children":[{"level":3,"title":"Executors","slug":"executors","link":"#executors","children":[]},{"level":3,"title":"非核心线程淘汰机制","slug":"非核心线程淘汰机制","link":"#非核心线程淘汰机制","children":[]},{"level":3,"title":"拒绝策略","slug":"拒绝策略","link":"#拒绝策略","children":[]},{"level":3,"title":"扩展方法","slug":"扩展方法","link":"#扩展方法","children":[]}]},{"level":2,"title":"线程安全","slug":"线程安全","link":"#线程安全","children":[{"level":3,"title":"JMM 内存模型","slug":"jmm-内存模型","link":"#jmm-内存模型","children":[]},{"level":3,"title":"ThreadLocal","slug":"threadlocal","link":"#threadlocal","children":[]},{"level":3,"title":"原子类（atomic）","slug":"原子类-atomic","link":"#原子类-atomic","children":[]},{"level":3,"title":"ABA 问题","slug":"aba-问题","link":"#aba-问题","children":[]},{"level":3,"title":"锁","slug":"锁","link":"#锁","children":[]}]},{"level":2,"title":"生产者/消费者模型","slug":"生产者-消费者模型","link":"#生产者-消费者模型","children":[]},{"level":2,"title":"协程/虚拟线程","slug":"协程-虚拟线程","link":"#协程-虚拟线程","children":[]},{"level":2,"title":"问题","slug":"问题","link":"#问题","children":[{"level":3,"title":"问题：ConcurrentHashMap 实现原理","slug":"问题-concurrenthashmap-实现原理","link":"#问题-concurrenthashmap-实现原理","children":[]},{"level":3,"title":"问题：实务多线程失效（❗ 解决方案有问题）","slug":"问题-实务多线程失效-❗-解决方案有问题","link":"#问题-实务多线程失效-❗-解决方案有问题","children":[]},{"level":3,"title":"问题：动态线程池 with Nacos","slug":"问题-动态线程池-with-nacos","link":"#问题-动态线程池-with-nacos","children":[]}]}],"git":{"createdTime":1716767237000,"updatedTime":1718473060000,"contributors":[{"name":"lawsssscat","email":"18041500+LawssssCat@users.noreply.github.com","commits":4}]},"readingTime":{"minutes":18.22,"words":5467},"filePathRelative":"zh/dev-java-commonsense/jdk-thread.md","localizedDate":"2024年5月24日","excerpt":"<h2>概念</h2>\\n<h3>JUC</h3>\\n<p>JUC <code>java.util.concurrent</code> 缩写</p>\\n<p>并发场景进行多线程编程的工具类</p>\\n<h3>进程、线程、协程</h3>\\n<p><strong>进程</strong> —— 一个应用，系统资源分配单位</p>\\n<p><strong>线程</strong> —— 一个应用的其中一个任务，共享进程资源</p>\\n<p><strong>协程</strong>/<strong>虚拟线程（Visual Thread）</strong> —— 在一个任务中，实现多任务有序的协作开展任务</p>\\n<ul>\\n<li>一个线程中可以有多个虚拟线程</li>\\n<li>不由系统管理，由 jvm 管理</li>\\n<li>由于由 jvm 管理，完全在内存中进行状态切换，所以创建和销毁的开销小，更高效</li>\\n</ul>","autoDesc":true}');export{W as comp,G as data};
